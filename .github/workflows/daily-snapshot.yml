name: PM33 Daily Development Snapshot

on:
  schedule:
    # Run daily at 6 PM PST (2 AM UTC next day)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

env:
  PROJECT_NAME: PM33 Strategic Intelligence Platform
  TARGET_MRR: 100K
  DEADLINE: Dec 31 2025

jobs:
  daily-snapshot:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Get full history for meaningful commit messages
        
    - name: Set up Git user
      run: |
        git config --global user.name "PM33 Daily Snapshot Bot"
        git config --global user.email "noreply@pm33.ai"
    
    - name: Generate snapshot summary
      id: snapshot
      run: |
        # Get project stats
        TOTAL_FILES=$(find . -type f -name "*.md" -o -name "*.py" -o -name "*.tsx" -o -name "*.ts" | wc -l)
        DOCUMENTATION_FILES=$(find . -name "*.md" | wc -l)  
        FRONTEND_FILES=$(find app/frontend -name "*.tsx" -o -name "*.ts" 2>/dev/null | wc -l || echo 0)
        BACKEND_FILES=$(find app/backend -name "*.py" 2>/dev/null | wc -l || echo 0)
        
        # Get recent changes
        CHANGES_TODAY=$(git log --since="24 hours ago" --oneline | wc -l)
        FILES_MODIFIED=$(git diff --name-only HEAD~1 2>/dev/null | wc -l || echo 0)
        
        # Calculate days until deadline
        DEADLINE_DATE="2025-12-31"
        DAYS_REMAINING=$(( ( $(date -d "$DEADLINE_DATE" +%s) - $(date +%s) ) / 86400 ))
        
        # Create snapshot summary
        cat > snapshot-summary.md << EOF
        # PM33 Daily Development Snapshot - $(date +%Y-%m-%d)
        
        ## ðŸŽ¯ **Project Status**
        - **Mission**: PMO Transformation through Agentic AI Teams
        - **Target**: $TARGET_MRR MRR by $DEADLINE  
        - **Days Remaining**: $DAYS_REMAINING days
        
        ## ðŸ“Š **Development Metrics**
        - **Total Project Files**: $TOTAL_FILES
        - **Documentation Files**: $DOCUMENTATION_FILES  
        - **Frontend Components**: $FRONTEND_FILES
        - **Backend Services**: $BACKEND_FILES
        - **Changes in Last 24h**: $CHANGES_TODAY commits
        - **Files Modified**: $FILES_MODIFIED
        
        ## ðŸ—ï¸ **Architecture Status**
        - âœ… 4 Agentic AI Teams Documented
        - âœ… Services Architecture (Railway, Pinecone, Claude, OpenAI, Together AI)
        - âœ… Design System: Marketing vs App Separation
        - âœ… Frontend: Next.js 15.4.6 + Mantine UI
        - ðŸŸ¡ Backend: FastAPI services (in progress)
        - ðŸŸ¡ Authentication: Multi-tenant system (planned)
        
        ## ðŸ“‹ **Key Documentation**
        - PM33_PRODUCT_REQUIREMENTS_DOCUMENT.md
        - INSTRUCTIONS-FOR-FUTURE-AGENTS.md  
        - Marketing: MARKETING_DESIGN_SYSTEM.md
        - App: APP_DESIGN_SYSTEM.md
        - Strategy: UNIFIED_MARKETING_STRATEGY.md
        
        ## ðŸ”„ **Recent Development Focus**
        $(git log --since="24 hours ago" --oneline --format="- %s" | head -10)
        
        ---
        *Automated snapshot generated by GitHub Actions*
        EOF
        
        echo "snapshot_created=true" >> $GITHUB_OUTPUT
        echo "days_remaining=$DAYS_REMAINING" >> $GITHUB_OUTPUT
        
    - name: Check for significant changes
      id: changes
      run: |
        # Check if any critical files were modified
        CRITICAL_FILES="CLAUDE.md INSTRUCTIONS-FOR-FUTURE-AGENTS.md PM33_PRODUCT_REQUIREMENTS_DOCUMENT.md"
        CRITICAL_CHANGED=false
        
        for file in $CRITICAL_FILES; do
          if git diff --name-only HEAD~1 | grep -q "$file"; then
            CRITICAL_CHANGED=true
            break
          fi
        done
        
        echo "critical_changed=$CRITICAL_CHANGED" >> $GITHUB_OUTPUT
        
    - name: Repository health check
      run: |
        echo "ðŸ¥ Running PM33 Repository Health Check"
        echo "======================================"
        
        # Repository structure analysis
        echo "ðŸ“Š Repository Basics:"
        echo "   Current branch: $(git branch --show-current)"
        echo "   Total commits: $(git rev-list --count HEAD)"
        echo "   Commits (last 24h): $(git rev-list --count --since="24 hours ago" HEAD)"
        echo "   Repository size: $(du -sh .git | cut -f1)"
        
        # Check PM33 critical files
        echo ""
        echo "ðŸ“‹ PM33 Critical Files:"
        for file in "CLAUDE.md" "INSTRUCTIONS-FOR-FUTURE-AGENTS.md" ".claude/commands/" "app/frontend/package.json"; do
          if [ -e "$file" ]; then
            echo "   âœ… $file: Present"
          else
            echo "   âŒ $file: Missing"
          fi
        done
        
        # Working directory health  
        UNTRACKED=$(git ls-files --others --exclude-standard | wc -l)
        MODIFIED=$(git diff --name-only | wc -l)
        echo ""
        echo "ðŸ’¾ Working Directory:"
        echo "   Untracked files: $UNTRACKED"
        echo "   Modified files: $MODIFIED"
        
        # Strategic development analysis
        echo ""
        echo "ðŸŽ¯ Strategic Development Status:"
        echo "   Days to \$100K MRR: ${{ steps.snapshot.outputs.days_remaining }}"
        
        # Check for 4 Agentic AI Teams implementation
        for team in "Strategic Intelligence" "Workflow Execution" "Data Intelligence" "Communication"; do
          team_files=$(find . -name "*.md" -o -name "*.tsx" -o -name "*.py" | xargs grep -l "$team" 2>/dev/null | wc -l || echo 0)
          echo "   $team AI Team: $team_files files"
        done
        
    - name: Git sync and backup
      run: |
        echo "ðŸ”„ Running PM33 Git Sync & Backup Process"
        echo "======================================="
        
        # Pre-backup status
        echo "ðŸ“Š Pre-Backup Status:"
        git status --porcelain
        
        # Add all changes following Claude Code best practices
        git add -A
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "âœ… No changes to commit - repository is clean"
        else
          echo "ðŸ’¾ Creating strategic backup commit..."
          
          # Create comprehensive commit message following PM33 standards
          COMMIT_MSG="ðŸ“¸ Daily PM33 Development Snapshot - $(date +%Y-%m-%d)
          
          ðŸŽ¯ PMO Transformation Platform Development
          ðŸ“… Days to \$100K MRR Target: ${{ steps.snapshot.outputs.days_remaining }}
          
          ðŸ“Š Development Activity:
          - Files modified: $(git diff --staged --name-only | wc -l)
          - Documentation updates: $(git diff --staged --name-only | grep '\.md$' | wc -l || echo 0)
          - Frontend components: $(git diff --staged --name-only | grep -E '\.(tsx?|ts)$' | wc -l || echo 0)
          - Backend services: $(git diff --staged --name-only | grep '\.py$' | wc -l || echo 0)
          - Configuration files: $(git diff --staged --name-only | grep -E '\.(json|yml|yaml|env)$' | wc -l || echo 0)
          
          ðŸ—ï¸ Strategic Areas Updated:
          $(git diff --staged --name-only | head -10 | sed 's/^/- /')
          
          ðŸ”§ Agentic AI Teams Status:
          - Strategic Intelligence: $(find . -name "*.md" -o -name "*.tsx" -o -name "*.py" | xargs grep -l "Strategic Intelligence" 2>/dev/null | wc -l || echo 0) references
          - Workflow Execution: $(find . -name "*.md" -o -name "*.tsx" -o -name "*.py" | xargs grep -l "Workflow Execution" 2>/dev/null | wc -l || echo 0) references
          - Data Intelligence: $(find . -name "*.md" -o -name "*.tsx" -o -name "*.py" | xargs grep -l "Data Intelligence" 2>/dev/null | wc -l || echo 0) references  
          - Communication: $(find . -name "*.md" -o -name "*.tsx" -o -name "*.py" | xargs grep -l "Communication" 2>/dev/null | wc -l || echo 0) references
          
          ðŸ’¾ Backup Metadata:
          - Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - Workflow: Daily Snapshot (Automated)
          - Total project files: $(find . -type f | wc -l)
          - Git objects: $(git count-objects | awk '{print $1}')
          
          ðŸ§  Generated with Claude Code - Daily Snapshot Workflow
          
          Co-Authored-By: Claude <noreply@anthropic.com>"
          
          git commit -m "$COMMIT_MSG"
          echo "âœ… Strategic backup commit created"
        fi
        
    - name: Push changes
      run: |
        git push origin main
        
    - name: Create issue for critical changes
      if: steps.changes.outputs.critical_changed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: issue } = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš¨ Critical PM33 Documentation Updated - $(date +%Y-%m-%d)`,
            body: `# Critical Project Files Modified
            
            Critical PM33 documentation files have been modified in today's snapshot. Please review:
            
            ## Modified Files
            - CLAUDE.md (Project memory and context)
            - INSTRUCTIONS-FOR-FUTURE-AGENTS.md (Agent guidance)  
            - PM33_PRODUCT_REQUIREMENTS_DOCUMENT.md (Product specification)
            
            ## Action Required
            - [ ] Review changes for accuracy
            - [ ] Update team on significant changes
            - [ ] Verify alignment with \$100K MRR by Dec 31 target
            
            ## Development Status
            Days remaining to target: ${{ steps.snapshot.outputs.days_remaining }}
            
            @claude Please review these critical changes and ensure consistency across all documentation.`,
            labels: ['documentation', 'critical-review', 'daily-snapshot']
          });
          
          console.log(\`Created issue #\${issue.number}\`);

    - name: Success notification
      if: success()
      run: |
        echo "âœ… Daily snapshot completed successfully"
        echo "ðŸ“Š Snapshot summary created"
        echo "ðŸ”„ Changes committed and pushed"
        echo "ðŸŽ¯ PM33 development progress tracked"